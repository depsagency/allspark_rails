<% content_for :title, "AI Generation Details" %>

<div class="container mx-auto px-4 py-8 max-w-6xl">
  <!-- Header -->
  <div class="mb-8">
    <div class="breadcrumbs text-sm mb-4">
      <ul>
        <li><%= link_to "AI Generations", ai_generations_path %></li>
        <li><%= @ai_generation.generation_type.humanize %> Generation</li>
      </ul>
    </div>
    
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-4">
      <div class="flex-1">
        <h1 class="text-4xl font-bold mb-2"><%= @ai_generation.generation_type.humanize %> Generation</h1>
        <div class="flex flex-wrap items-center gap-3">
          <%= render Ui::BadgeComponent.new(variant: @ai_generation.status.to_sym) do %>
            <%= @ai_generation.status.humanize %>
          <% end %>
          <%= render Ui::BadgeComponent.new(variant: :outline) do %>
            <%= @ai_generation.llm_provider.upcase %>
          <% end %>
          <span class="text-sm text-gray-600">
            Created <%= @ai_generation.created_at.strftime("%B %d, %Y at %l:%M %p") %>
          </span>
        </div>
      </div>
      
      <div class="flex gap-2">
        <%= render Ui::ButtonComponent.new(variant: :outline, href: ai_generations_path) do %>
          ‚Üê Back to All Generations
        <% end %>
        
        <% if @ai_generation.app_project %>
          <%= render Ui::ButtonComponent.new(variant: :outline, href: app_project_path(@ai_generation.app_project)) do %>
            View Project
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Generation Details -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Stats -->
    <%= render Ui::CardComponent.new(shadow: true) do |card| %>
      <%= card.with_body do %>
        <h3 class="text-lg font-semibold mb-4">Generation Stats</h3>
        
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-600">Project:</span>
            <% if @ai_generation.app_project %>
              <%= link_to @ai_generation.app_project.name, app_project_path(@ai_generation.app_project), 
                          class: "font-medium text-primary hover:underline" %>
            <% else %>
              <span class="text-gray-400">Unknown</span>
            <% end %>
          </div>
          
          <div class="flex justify-between">
            <span class="text-gray-600">Provider:</span>
            <span class="font-medium"><%= @ai_generation.llm_provider.upcase %></span>
          </div>
          
          <div class="flex justify-between">
            <span class="text-gray-600">Model:</span>
            <span class="font-medium text-sm"><%= @ai_generation.model_used || "Unknown" %></span>
          </div>
          
          <div class="flex justify-between">
            <span class="text-gray-600">Status:</span>
            <%= render Ui::BadgeComponent.new(variant: @ai_generation.status.to_sym, size: :sm) do %>
              <%= @ai_generation.status.humanize %>
            <% end %>
          </div>
          
          <% if @ai_generation.token_count.present? %>
            <div class="flex justify-between">
              <span class="text-gray-600">Tokens:</span>
              <span class="font-medium"><%= number_with_delimiter(@ai_generation.token_count) %></span>
            </div>
          <% end %>
          
          <% if @ai_generation.cost.present? %>
            <div class="flex justify-between">
              <span class="text-gray-600">Cost:</span>
              <span class="font-medium">$<%= '%.4f' % @ai_generation.cost %></span>
            </div>
          <% end %>
          
          <% if @ai_generation.processing_time_seconds.present? %>
            <div class="flex justify-between">
              <span class="text-gray-600">Processing Time:</span>
              <span class="font-medium"><%= @ai_generation.processing_time_seconds.round(2) %>s</span>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <!-- Timestamps -->
    <%= render Ui::CardComponent.new(shadow: true) do |card| %>
      <%= card.with_body do %>
        <h3 class="text-lg font-semibold mb-4">Timestamps</h3>
        
        <div class="space-y-3">
          <div>
            <div class="text-sm text-gray-600">Created</div>
            <div class="font-medium"><%= @ai_generation.created_at.strftime("%B %d, %Y") %></div>
            <div class="text-xs text-gray-500"><%= @ai_generation.created_at.strftime("%l:%M:%S %p %Z") %></div>
          </div>
          
          <div>
            <div class="text-sm text-gray-600">Updated</div>
            <div class="font-medium"><%= @ai_generation.updated_at.strftime("%B %d, %Y") %></div>
            <div class="text-xs text-gray-500"><%= @ai_generation.updated_at.strftime("%l:%M:%S %p %Z") %></div>
          </div>
          
          <% if @ai_generation.completed? %>
            <div>
              <div class="text-sm text-gray-600">Status</div>
              <div class="font-medium">Completed</div>
              <div class="text-xs text-gray-500">Generation finished successfully</div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <!-- Actions -->
    <%= render Ui::CardComponent.new(shadow: true) do |card| %>
      <%= card.with_body do %>
        <h3 class="text-lg font-semibold mb-4">Actions</h3>
        
        <div class="space-y-2">
          <% if @ai_generation.input_prompt.present? %>
            <button onclick="copyToClipboard('input-prompt')" class="btn btn-outline btn-sm w-full">
              Copy Input Prompt
            </button>
          <% end %>
          
          <% if @ai_generation.raw_output.present? %>
            <button onclick="copyToClipboard('raw-output')" class="btn btn-outline btn-sm w-full">
              Copy Output
            </button>
          <% end %>
          
          <% if @ai_generation.error_message.present? %>
            <button onclick="copyToClipboard('error-message')" class="btn btn-outline btn-sm w-full">
              Copy Error Details
            </button>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- Input Prompt -->
  <% if @ai_generation.input_prompt.present? %>
    <div class="mb-8">
      <%= render Ui::CardComponent.new(shadow: true) do |card| %>
        <%= card.with_body do %>
          <h3 class="text-xl font-semibold mb-4">Input Prompt</h3>
          <div id="input-prompt" class="bg-gray-50 p-4 rounded-lg border">
            <pre class="whitespace-pre-wrap text-sm font-mono leading-relaxed"><%= @ai_generation.input_prompt %></pre>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- Output -->
  <% if @ai_generation.raw_output.present? %>
    <div class="mb-8">
      <%= render Ui::CardComponent.new(shadow: true) do |card| %>
        <%= card.with_body do %>
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Generated Output</h3>
            <div class="flex gap-2">
              <button onclick="toggleView('raw')" id="raw-btn" class="btn btn-outline btn-sm">Raw</button>
              <button onclick="toggleView('rendered')" id="rendered-btn" class="btn btn-primary btn-sm">Rendered</button>
            </div>
          </div>
          
          <!-- Raw Output -->
          <div id="raw-output" class="hidden bg-gray-50 p-4 rounded-lg border">
            <pre class="whitespace-pre-wrap text-sm font-mono leading-relaxed"><%= @ai_generation.raw_output %></pre>
          </div>
          
          <!-- Rendered Output -->
          <div id="rendered-output" class="prose prose-sm max-w-none">
            <%= markdown_to_html(@ai_generation.raw_output) %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- Error Details -->
  <% if @ai_generation.error_message.present? %>
    <div class="mb-8">
      <%= render Ui::CardComponent.new(shadow: true, css_class: "border-red-200") do |card| %>
        <%= card.with_body do %>
          <h3 class="text-xl font-semibold mb-4 text-red-600">Error Details</h3>
          <div id="error-message" class="bg-red-50 p-4 rounded-lg border border-red-200">
            <pre class="whitespace-pre-wrap text-sm font-mono leading-relaxed text-red-800"><%= @ai_generation.error_message %></pre>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- JavaScript for functionality -->
<script>
// Copy to clipboard functionality
function copyToClipboard(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent || element.innerText;
  
  navigator.clipboard.writeText(text).then(function() {
    // Show success feedback
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('btn-success');
    
    setTimeout(function() {
      btn.textContent = originalText;
      btn.classList.remove('btn-success');
    }, 2000);
  }).catch(function(err) {
    console.error('Failed to copy text: ', err);
  });
}

// Toggle between raw and rendered output
function toggleView(view) {
  const rawOutput = document.getElementById('raw-output');
  const renderedOutput = document.getElementById('rendered-output');
  const rawBtn = document.getElementById('raw-btn');
  const renderedBtn = document.getElementById('rendered-btn');
  
  if (view === 'raw') {
    rawOutput.classList.remove('hidden');
    renderedOutput.classList.add('hidden');
    rawBtn.classList.add('btn-primary');
    rawBtn.classList.remove('btn-outline');
    renderedBtn.classList.remove('btn-primary');
    renderedBtn.classList.add('btn-outline');
  } else {
    rawOutput.classList.add('hidden');
    renderedOutput.classList.remove('hidden');
    rawBtn.classList.remove('btn-primary');
    rawBtn.classList.add('btn-outline');
    renderedBtn.classList.add('btn-primary');
    renderedBtn.classList.remove('btn-outline');
  }
}
</script>