<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-start mb-8">
    <div>
      <h1 class="text-3xl font-bold"><%= @workflow.name %></h1>
      <% if @workflow.description.present? %>
        <p class="text-base-content/70 mt-2"><%= @workflow.description %></p>
      <% end %>
      <div class="flex gap-2 mt-3">
        <span class="badge badge-<%= @workflow.status == 'active' ? 'success' : @workflow.status == 'draft' ? 'warning' : 'ghost' %>">
          <%= @workflow.status %>
        </span>
        <span class="badge badge-outline">Version <%= @workflow.version %></span>
        <span class="text-sm opacity-60">
          Created by <%= @workflow.user.email %> • 
          Updated <%= time_ago_in_words(@workflow.updated_at) %> ago
        </span>
      </div>
    </div>
    
    <div class="flex gap-2">
      <% if @workflow.status == 'active' %>
        <%= button_to execute_agents_team_workflow_path(@team, @workflow), 
            method: :post,
            class: "btn btn-primary",
            form: { class: "inline" } do %>
          ▶️ Run Workflow
        <% end %>
      <% end %>
      
      <%= link_to "Edit", edit_agents_team_workflow_path(@team, @workflow), 
          class: "btn btn-ghost" %>
      
      <div class="dropdown dropdown-end">
        <label tabIndex={0} class="btn btn-ghost">
          •••
        </label>
        <ul tabIndex={0} class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
          <li>
            <%= button_to "Duplicate", duplicate_agents_team_workflow_path(@team, @workflow), 
                method: :post,
                class: "btn btn-ghost btn-sm w-full justify-start" %>
          </li>
          <li><%= link_to "Export as Mermaid", export_agents_team_workflow_path(@team, @workflow, format: :text), class: "btn btn-ghost btn-sm w-full justify-start" %></li>
          <li><%= link_to "Export as JSON", export_agents_team_workflow_path(@team, @workflow, format: :json), class: "btn btn-ghost btn-sm w-full justify-start" %></li>
          <li class="text-error">
            <%= button_to "Archive", agents_team_workflow_path(@team, @workflow), 
                method: :delete,
                class: "btn btn-ghost btn-sm w-full justify-start text-error",
                form: { data: { turbo_confirm: "Are you sure you want to archive this workflow?" } } %>
          </li>
        </ul>
      </div>
      
      <%= link_to "Back to Team", agents_team_path(@team), class: "btn btn-ghost" %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Workflow Preview -->
    <div class="lg:col-span-2">
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="card-title">Workflow Preview</h2>
            <%= link_to edit_agents_team_workflow_path(@team, @workflow), 
                class: "btn btn-primary btn-sm" do %>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l9.932-9.931Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 7.125M18 10.875V19.5a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 19.5V6.375m14.5.375a2.25 2.25 0 0 1 2.25-2.25 3 3 0 0 0-3-3h-10.5a3 3 0 0 0-3 3 2.25 2.25 0 0 1 2.25 2.25m10.5 0h-10.5" />
              </svg>
              Open in Editor
            <% end %>
          </div>
          
          <% if @workflow.flow_definition['nodes']&.any? %>
            <!-- Mermaid diagram preview -->
            <div class="bg-base-200 rounded-lg p-8 min-h-[400px] flex items-center justify-center">
              <div class="text-center max-w-2xl">
                <pre class="mermaid">
<%= @workflow.to_mermaid %>
                </pre>
              </div>
            </div>
            
            <div class="mt-4 text-sm text-base-content/60 text-center">
              This is a simplified diagram view. Click "Open in Editor" to see the full interactive workflow.
            </div>
          <% else %>
            <!-- Empty state -->
            <div class="bg-base-200 rounded-lg p-16 text-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="w-16 h-16 mx-auto mb-4 opacity-20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
              </svg>
              <p class="text-lg font-medium mb-2">No workflow defined yet</p>
              <p class="text-sm opacity-60 mb-4">Start building your workflow in the editor</p>
              <%= link_to "Open Editor", edit_agents_team_workflow_path(@team, @workflow), 
                  class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Recent Executions -->
      <div class="card bg-base-100 shadow-xl mt-6">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="card-title">Recent Executions</h2>
            <%= link_to "View All", agents_team_workflow_executions_path(@team, @workflow), 
                class: "btn btn-ghost btn-sm" %>
          </div>
          
          <% recent_executions = @workflow.workflow_executions.order(created_at: :desc).limit(5) %>
          <% if recent_executions.any? %>
            <div class="space-y-3">
              <% recent_executions.each do |execution| %>
                <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                  <div>
                    <div class="font-medium">
                      Execution #<%= execution.id.last(8) %>
                    </div>
                    <div class="text-sm opacity-70">
                      <%= time_ago_in_words(execution.created_at) %> ago
                      <% if execution.elapsed_time %>
                        • Duration: <%= distance_of_time_in_words(execution.elapsed_time) %>
                      <% end %>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="badge badge-<%= execution.completed? ? 'success' : execution.failed? ? 'error' : execution.cancelled? ? 'ghost' : 'warning' %>">
                      <%= execution.status %>
                    </div>
                    <%= link_to "View", agents_team_workflow_execution_path(@team, @workflow, execution), 
                        class: "btn btn-ghost btn-xs" %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-center py-8 opacity-70">No executions yet</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Workflow Info -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h3 class="font-bold text-lg mb-4">Workflow Information</h3>
          
          <div class="space-y-3">
            <div>
              <div class="text-sm font-semibold opacity-70">Status</div>
              <div class="mt-1">
                <% case @workflow.status %>
                <% when 'active' %>
                  <span class="badge badge-success">Active - Ready to run</span>
                <% when 'draft' %>
                  <span class="badge badge-warning">Draft - Still editing</span>
                <% else %>
                  <span class="badge badge-ghost">Archived</span>
                <% end %>
              </div>
            </div>
            
            <div>
              <div class="text-sm font-semibold opacity-70">Version</div>
              <div class="mt-1"><%= @workflow.version %></div>
            </div>
            
            <div>
              <div class="text-sm font-semibold opacity-70">Created</div>
              <div class="mt-1">
                <%= @workflow.created_at.strftime("%B %d, %Y") %>
                <div class="text-xs opacity-60">by <%= @workflow.user.email %></div>
              </div>
            </div>
            
            <div>
              <div class="text-sm font-semibold opacity-70">Last Updated</div>
              <div class="mt-1"><%= @workflow.updated_at.strftime("%B %d, %Y at %I:%M %p") %></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Workflow Stats -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h3 class="font-bold text-lg mb-4">Workflow Statistics</h3>
          
          <%
            nodes = @workflow.flow_definition['nodes'] || []
            edges = @workflow.flow_definition['edges'] || []
            task_nodes = nodes.select { |n| n['type'] == 'task' || n['type'] == 'assistant' }
            decision_nodes = nodes.select { |n| n['type'] == 'decision' }
          %>
          
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-sm">Total Nodes</span>
              <span class="font-semibold"><%= nodes.count %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm">Task Nodes</span>
              <span class="font-semibold"><%= task_nodes.count %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm">Decision Points</span>
              <span class="font-semibold"><%= decision_nodes.count %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm">Connections</span>
              <span class="font-semibold"><%= edges.count %></span>
            </div>
            
            <div class="divider"></div>
            
            <div class="flex justify-between">
              <span class="text-sm">Total Executions</span>
              <span class="font-semibold"><%= @workflow.workflow_executions.count %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm">Success Rate</span>
              <span class="font-semibold">
                <% if @workflow.workflow_executions.any? %>
                  <%= (@workflow.workflow_executions.completed.count.to_f / @workflow.workflow_executions.count * 100).round %>%
                <% else %>
                  N/A
                <% end %>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h3 class="font-bold text-lg mb-4">Quick Actions</h3>
          
          <div class="space-y-2">
            <% if @workflow.status == 'draft' %>
              <%= button_to agents_team_workflow_path(@team, @workflow), 
                  method: :patch,
                  params: { workflow: { status: 'active' } },
                  class: "btn btn-primary btn-block",
                  form: { class: "w-full" } do %>
                ✅ Activate Workflow
              <% end %>
            <% elsif @workflow.status == 'active' %>
              <%= button_to agents_team_workflow_path(@team, @workflow), 
                  method: :patch,
                  params: { workflow: { status: 'draft' } },
                  class: "btn btn-warning btn-block",
                  form: { class: "w-full" } do %>
                📝 Set to Draft
              <% end %>
            <% end %>
            
            <%= button_to duplicate_agents_team_workflow_path(@team, @workflow), 
                method: :post,
                class: "btn btn-outline btn-block",
                form: { class: "w-full" } do %>
              📋 Duplicate Workflow
            <% end %>
            
            <%= link_to export_agents_team_workflow_path(@team, @workflow, format: :text), 
                class: "btn btn-outline btn-block" do %>
              📄 Download as Mermaid
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Mermaid for workflow diagram -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  // Initialize Mermaid diagrams
  document.addEventListener('DOMContentLoaded', () => {
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'default',
      themeVariables: {
        primaryColor: '#f3f4f6',
        primaryTextColor: '#111827',
        primaryBorderColor: '#d1d5db',
        lineColor: '#6b7280',
        secondaryColor: '#e5e7eb',
        tertiaryColor: '#f9fafb'
      }
    });
  });
  
  // Re-render on Turbo navigation
  document.addEventListener('turbo:load', () => {
    mermaid.init();
  });
</script>