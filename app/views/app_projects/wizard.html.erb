<% content_for :title, "App Builder Wizard" %>

<div class="container mx-auto px-4 py-8 max-w-4xl">
  <!-- Progress Header -->
  <div class="mb-8">
    <div class="text-center mb-6">
      <h1 class="text-4xl font-bold mb-2">App Builder Wizard</h1>
      <p class="text-gray-600">Transform your idea into a comprehensive development plan</p>
    </div>
    
    <!-- Progress Indicator -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium">Question <%= @current_step %> of 10</span>
        <span class="text-sm text-gray-600"><%= (@current_step * 10) %>% Complete</span>
      </div>
    </div>
    
    <!-- Steps Navigation -->
    <div class="flex justify-center mb-8 hidden md:flex">
      <div class="steps steps-horizontal">
        <% step_labels = ["Vision", "Users", "Journeys", "Features", "Technical", "Integrations", "Success", "Competition", "Design", "Challenges"] %>
        <% (1..10).each do |step| %>
          <% if @app_project.persisted? %>
            <%= link_to wizard_app_projects_path(project_slug: @app_project.slug, step: step), 
                        class: "step #{step <= @current_step ? 'step-primary' : ''} hover:bg-base-200 transition-colors cursor-pointer" do %>
              <%= step_labels[step - 1] %>
            <% end %>
          <% else %>
            <div class="step <%= 'step-primary' if step <= @current_step %>">
              <%= step_labels[step - 1] %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Question Form -->
  <% 
    form_data = { controller: "autosave" }
    if @app_project.persisted?
      form_data[:autosave_url_value] = app_project_path(@app_project)
      form_data[:autosave_method_value] = "PATCH"
    end
  %>
  <%= form_with(model: @app_project, 
                url: wizard_app_projects_path, 
                method: :post, 
                local: true,
                data: form_data) do |form| %>
    
    <%= hidden_field_tag :step, @current_step %>
    <%= hidden_field_tag :project_slug, @app_project.slug if @app_project.persisted? %>
    
    <%= render Ui::CardComponent.new(shadow: true, css_class: "mb-8") do |card| %>
      <%= card.with_body do %>
        <!-- Question Header -->
        <div class="mb-6">
          <h2 class="text-2xl font-bold mb-3"><%= @current_question[:title] %></h2>
          <p class="text-gray-700 text-lg"><%= @current_question[:prompt] %></p>
          
          <% if @current_question[:example] %>
            <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
              <p class="text-sm text-blue-700">
                <strong>Example:</strong> <%= @current_question[:example] %>
              </p>
            </div>
          <% end %>
        </div>
        
        <!-- Answer Field -->
        <div class="mb-6">
          <% 
            textarea_data = {}
            if @app_project.persisted?
              textarea_data[:action] = "input->autosave#scheduleAutoSave"
              textarea_data[:autosave_target] = "field"
            end
          %>
          <%= form.text_area @current_question[:field], 
                             placeholder: @current_question[:placeholder],
                             rows: 12,
                             class: "textarea textarea-bordered w-full text-base leading-relaxed",
                             data: textarea_data %>
          
          <div class="flex justify-between items-center mt-2">
            <div class="text-sm text-gray-500">
              <% if @app_project.persisted? %>
                <span data-autosave-target="status">Auto-save ready</span>
              <% else %>
                <span class="text-gray-400">Auto-save will be enabled after creating project</span>
              <% end %>
            </div>
            <div class="text-sm text-gray-500">
              <span id="char-count">0</span> characters
            </div>
          </div>
        </div>
        
        <!-- Character Counter and Guidance -->
        <div class="mb-6">
          <div class="text-sm text-gray-600">
            <p><strong>Tips for a great response:</strong></p>
            <ul class="list-disc list-inside mt-2 space-y-1">
              <% case @current_step
                 when 1 %>
                <li>Clearly explain the problem your app solves</li>
                <li>Describe your target audience</li>
                <li>Explain your unique value proposition</li>
              <% when 2 %>
                <li>Think about different user types (customers, admins, etc.)</li>
                <li>Include demographics and behaviors</li>
                <li>Describe their goals and pain points</li>
              <% when 3 %>
                <li>Walk through complete user workflows</li>
                <li>Include decision points and alternatives</li>
                <li>Consider edge cases and error scenarios</li>
              <% when 4 %>
                <li>List must-have vs. nice-to-have features</li>
                <li>Explain how features connect to user needs</li>
                <li>Consider admin and management features</li>
              <% when 5 %>
                <li>Specify platform requirements (web, mobile, etc.)</li>
                <li>Include performance and scaling needs</li>
                <li>Mention security and compliance requirements</li>
              <% when 6 %>
                <li>List payment, email, and other service needs</li>
                <li>Explain what data flows in and out</li>
                <li>Consider authentication providers</li>
              <% when 7 %>
                <li>Define specific, measurable goals</li>
                <li>Include both business and technical metrics</li>
                <li>Set realistic timelines</li>
              <% when 8 %>
                <li>Research existing solutions honestly</li>
                <li>Explain your unique differentiators</li>
                <li>Identify potential partnership opportunities</li>
              <% when 9 %>
                <li>Describe your visual style preferences</li>
                <li>Include accessibility requirements</li>
                <li>Consider mobile-first design needs</li>
              <% when 10 %>
                <li>Be honest about technical challenges</li>
                <li>Consider resource and timeline constraints</li>
                <li>Think about user adoption challenges</li>
              <% end %>
            </ul>
          </div>
        </div>
      <% end %>
    <% end %>
    
    <!-- Navigation Buttons -->
    <div class="flex justify-between items-center">
      <div class="flex gap-3">
        <% if @current_step > 1 %>
          <%= render Ui::ButtonComponent.new(variant: :outline, href: wizard_app_projects_path(project_slug: @app_project.slug, step: @current_step - 1)) do %>
            ← Previous
          <% end %>
        <% else %>
          <%= render Ui::ButtonComponent.new(variant: :outline, href: app_projects_path) do %>
            ← Back to Projects
          <% end %>
        <% end %>
        
        <% if @app_project.persisted? %>
          <%= render Ui::ButtonComponent.new(variant: :ghost, href: wizard_app_projects_path(project_slug: @app_project.slug, step: @current_step + 1)) do %>
            Skip Question
          <% end %>
        <% end %>
      </div>
      
      <div class="flex gap-3">
        <% if @current_step < 10 %>
          <%= render Ui::ButtonComponent.new(variant: :primary, type: :submit) do %>
            Next Question →
          <% end %>
        <% else %>
          <%= render Ui::ButtonComponent.new(variant: :primary, type: :submit) do %>
            Complete Questionnaire
          <% end %>
        <% end %>
      </div>
    </div>
    
    <!-- Project Name Field for First Step -->
    <% if @current_step == 1 && !@app_project.persisted? %>
      <%= render Ui::CardComponent.new(shadow: true, css_class: "mt-8") do |card| %>
        <%= card.with_body do %>
          <h3 class="text-lg font-semibold mb-4">Project Details</h3>
          <div class="form-control">
            <%= form.label :name, class: "label" do %>
              <span class="label-text font-medium">Project Name</span>
            <% end %>
            <%= form.text_field :name, 
                               placeholder: "e.g., TaskFlow Manager, Social Marketplace, etc.",
                               class: "input input-bordered w-full",
                               required: true %>
            <div class="label">
              <span class="label-text-alt">This will be used to identify your project</span>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
  
  <!-- Help Section -->
  <div class="mt-12">
    <%= render Ui::CardComponent.new(bordered: true, css_class: "bg-gray-50") do |card| %>
      <%= card.with_body do %>
        <div class="text-center">
          <h3 class="text-lg font-semibold mb-2">Need Help?</h3>
          <p class="text-gray-600 mb-4">
            The more detailed your responses, the better your generated PRD will be. 
            Don't worry about perfect answers – you can always edit them later.
          </p>
          
          <div class="flex justify-center gap-4">
            <%= render Ui::ButtonComponent.new(variant: :outline, size: :sm, href: app_projects_path) do %>
              Save & Continue Later
            <% end %>
            
            <% if @app_project.persisted? && @app_project.completion_percentage >= 70 %>
              <%= render Ui::ButtonComponent.new(variant: :secondary, size: :sm, href: app_project_path(@app_project)) do %>
                Generate PRD Now
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<!-- Auto-save Stimulus Controller -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.querySelector('textarea');
  const charCount = document.getElementById('char-count');
  
  if (textarea && charCount) {
    function updateCharCount() {
      charCount.textContent = textarea.value.length;
    }
    
    textarea.addEventListener('input', updateCharCount);
    updateCharCount(); // Initial count
  }
});
</script>